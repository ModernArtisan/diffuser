<!DOCTYPE html>

<html>
<head>
  <title>connectee.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="actor.js.html">
                  actor.js
                </a>


                <a class="source" href="addresser.js.html">
                  addresser.js
                </a>


                <a class="source" href="connectee.js.html">
                  connectee.js
                </a>


                <a class="source" href="connector.js.html">
                  connector.js
                </a>


                <a class="source" href="consensus.js.html">
                  consensus.js
                </a>


                <a class="source" href="countdown.js.html">
                  countdown.js
                </a>


                <a class="source" href="diffuser.bin.js.html">
                  diffuser.bin.js
                </a>


                <a class="source" href="diffuser.js.html">
                  diffuser.js
                </a>


                <a class="source" href="dispatcher.js.html">
                  dispatcher.js
                </a>


                <a class="source" href="embarkator.js.html">
                  embarkator.js
                </a>


                <a class="source" href="hangup.js.html">
                  hangup.js
                </a>


                <a class="source" href="hash.js.html">
                  hash.js
                </a>


                <a class="source" href="initializer.js.html">
                  initializer.js
                </a>


                <a class="source" href="listener.js.html">
                  listener.js
                </a>


                <a class="source" href="lookup.js.html">
                  lookup.js
                </a>


                <a class="source" href="olio.js.html">
                  olio.js
                </a>


                <a class="source" href="registrar.js.html">
                  registrar.js
                </a>


                <a class="source" href="requester.js.html">
                  requester.js
                </a>


                <a class="source" href="sender.js.html">
                  sender.js
                </a>


                <a class="source" href="socketeer.js.html">
                  socketeer.js
                </a>


                <a class="source" href="table.js.html">
                  table.js
                </a>


                <a class="source" href="updater.js.html">
                  updater.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>connectee.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Node.js API.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Control-flow utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> delta = <span class="hljs-built_in">require</span>(<span class="hljs-string">'delta'</span>)

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Sockets as multiplexed event queues.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Procession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession'</span>)
<span class="hljs-keyword">var</span> Conduit = <span class="hljs-built_in">require</span>(<span class="hljs-string">'conduit/conduit'</span>)
<span class="hljs-keyword">var</span> Socket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession/socket'</span>)(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./hangup'</span>))
<span class="hljs-keyword">var</span> Window = <span class="hljs-built_in">require</span>(<span class="hljs-string">'conduit/window'</span>)

<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'diffuser'</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Controlled demoltion of evented objects.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Destructible = <span class="hljs-built_in">require</span>(<span class="hljs-string">'destructible'</span>)

<span class="hljs-keyword">var</span> Staccato = <span class="hljs-built_in">require</span>(<span class="hljs-string">'staccato'</span>)

<span class="hljs-keyword">var</span> Addresser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./addresser'</span>)

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Our constructor is invoked by the <code>Destructible</code> constructor we export. This
object is only supposed to be created by and used with <code>Destructible</code>.</p>
<p>The <code>_connections</code> collection is a collection of windows. A window represents a
message queue for messages received for another diffuser participant, one of
our peers. It’s called a window because our peer maintains a queue of
messages that are only cleared when assure it that the messages have been
received. If our socket to a particular peer breaks, it will create a new
socket to reconnect to us and resume communication. Its window will replay
the queued messages and the window on our side end will skip over the ones it
has already received.</p>
<p>The <code>Window</code> class is bi-directional, but we’re only really sending
information in one direction through each socket. This means that each
pairing of peers will open two sockets. Maybe some day we’ll sort out how to
open only one socket to use each way, but it is easier to open a socket in
response </p>
<p>Our <code>_window</code> collection is keyed on the unique key in the atomic log that
introduced a our peer as a new participant. We call this unique key a promise
because that’s what Paxos calls it.</p>
<p>All </p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Connectee</span> (<span class="hljs-params">destructible</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Our life-cycle manager.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._destructible = destructible

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Collection of windows.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._connections = <span class="hljs-keyword">new</span> Addresser

</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Common inbox from all windows.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.inbox = <span class="hljs-keyword">new</span> Procession

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Close all windows when it’s time to go.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    destructible.destruct.wait(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>._diffLocations({}) })
}

</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Invoked when a new routing table is created. We will close any windows open
to instances that no longer exist.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype.setRoutes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">routes</span>) </span>{
    <span class="hljs-keyword">this</span>._diffLocations(routes.properties)
}

</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Close any open windows that do not have a value for their promise </p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype._diffLocations = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">properties</span>) </span>{
    <span class="hljs-keyword">this</span>._connections.promises().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promise</span>) </span>{
        <span class="hljs-keyword">if</span> (!(promise <span class="hljs-keyword">in</span> properties)) {
            collection.list(promise).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
                connection.destructibles.window.destroy()
            })
        }
    })
}

</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Get a connection or construct one if one does not exist. The absence of a
<code>window</code> property will serve to indicate that the connection needs to be
networked.</p>

            </div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Connector.prototype._getConnection = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promise</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Get the existing connection.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._connections.get(promise)

</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Create a connection if none exists.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (connection == <span class="hljs-literal">null</span>) {
</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>This outbox will be replaced with the window’s outbox once it’s
created.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> outbox = <span class="hljs-keyword">new</span> Procession
        <span class="hljs-keyword">this</span>._connections.put(promise, connection = {
            <span class="hljs-attr">window</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">peer</span>: promise,
            <span class="hljs-attr">outbox</span>: outbox,
            <span class="hljs-attr">shifter</span>: outbox.shifter()
            destructibles: {
                <span class="hljs-attr">window</span>: <span class="hljs-keyword">new</span> Destructible(<span class="hljs-string">'dummy'</span>),
                <span class="hljs-attr">socket</span>: <span class="hljs-keyword">new</span> Destructible(<span class="hljs-string">'dummy'</span>)
            }
        })
</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>We might destroy this connection before a window is ever created, so
we register the one thing we’ll need to do to clean up this stub.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        connection.destructibles.window.destruct.wait(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>._connections.remove(promise)
        })
    }

    <span class="hljs-keyword">return</span> connection
}


</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Connector.prototype.connect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">to</span>) </span>{
    <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._getConnection(to)
    <span class="hljs-keyword">if</span> (connection.window == <span class="hljs-literal">null</span> &amp;&amp; Monotonic.compare(<span class="hljs-keyword">this</span>._routes.from.promise, to) &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>._connect(to, <span class="hljs-literal">true</span>, to, <span class="hljs-literal">null</span>)
    }
    <span class="hljs-keyword">return</span> connection.outbox
}

</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Push is synchronous.</p>

            </div>

            <div class="content"><div class='highlight'><pre>
Connector.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._router.properties[envelope.to.promise] != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._getConnection(to)
</pre></div></div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If we have no window and our promise is less than our peers, we
connect, otherwise we wait for our peer to connect to us.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (connection.window == <span class="hljs-literal">null</span> &amp;&amp; Monotonic.compare(<span class="hljs-keyword">this</span>._routes.from.promise, to) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>._connect(to, <span class="hljs-literal">true</span>, to, <span class="hljs-literal">null</span>)
        }
        connection.outbox.push(envelope)
    }
}

</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Create a window and keep it around for reconnections. We build it under it’s
own destructible invoked below as a destructible that can terminate
independently of the application. Note that we keep the sub-destructible in
our window collection so we can close the window and destroy all it’s helpers
when it comes time to shutdown.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype._window = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible, promise</span>) </span>{
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Construct a Window.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.monitor(<span class="hljs-string">'window'</span>, Window, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">window</span>) </span>{
        <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._connections.get(promise)

</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Keep the <code>Destructible</code> for the <code>Window</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        connection.destructibles.window = destructible

</pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Drain any messages waiting for the window’s creation and replace the
initial outbox with the window’s outbox.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        connection.outbox.drain(<span class="hljs-built_in">window</span>.outbox, <span class="hljs-string">'push'</span>)
        connection.outbox = <span class="hljs-built_in">window</span>.outbox

</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>We use <code>Window.truncate</code> to correctly close the <code>Window.inbox</code>. The
<code>Window.outbox</code> we can close directly.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.destruct.wait(<span class="hljs-built_in">window</span>, <span class="hljs-string">'truncate'</span>)
        destructible.destruct.wait(<span class="hljs-built_in">window</span>.outbox, <span class="hljs-string">'end'</span>)

</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>We want to pump the <code>Window.inbox</code> into our common <code>inbox</code>, but we
don’t want to close the common <code>inbox</code> by pushing <code>null</code> which means
end-of-queue.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.monitor(<span class="hljs-string">'inbox'</span>, <span class="hljs-built_in">window</span>.inbox.pump(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
            <span class="hljs-keyword">if</span> (envelope != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">this</span>.inbox.push(envelope)
            }
        }), <span class="hljs-string">'destructible'</span>, <span class="hljs-literal">null</span>)

</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If the window is destroyed, any associate socket also needs be
destroyed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.destruct.wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>._get.remove(promise).destructibles.socket.destroy() })

</pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Finally, we remove the window from our window collection.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.destruct.wait(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>._connections.remove(<span class="hljs-keyword">from</span>) })
    })
})

</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Construct a conduit around an incoming socket.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype._conduit = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible, from, window, socket</span>) </span>{
    destructible.destruct.wait(socket, <span class="hljs-string">'destroy'</span>)
    <span class="hljs-keyword">var</span> windowed = <span class="hljs-keyword">this</span>._connections.get(<span class="hljs-keyword">from</span>)
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Wait for the existing socket to close and, yes, destroy it in case
we’re called while it is still open.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        windowed.destructibles.socket.destroy()
        windowed.destructibles.socket.destruct.wait(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Create a new socket.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> readable = <span class="hljs-keyword">new</span> Staccato.Readable(socket)
        <span class="hljs-keyword">var</span> writable = <span class="hljs-keyword">new</span> Staccato.Writable(socket)
        destructible.monitor(<span class="hljs-string">'socket'</span>, <span class="hljs-literal">true</span>, Socket, { <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span> }, readable, writable, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">inbox, outbox</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Bind our socket to a Conduit server that will reconnect the window
and listen for pings.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        destructible.monitor(<span class="hljs-string">'conduit'</span>, Conduit, inbox, outbox, <span class="hljs-keyword">this</span>, cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, request, inbox, outbox</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'here'</span>, request)
                process.exit()
            <span class="hljs-keyword">switch</span> (request.method) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'window'</span>:
                <span class="hljs-built_in">window</span>.connect(inbox, outbox)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'ping'</span>:
</pre></div></div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO Ping.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">break</span>
            }
        }), <span class="hljs-keyword">async</span>())
    })
})

</pre></div></div>

        </li>


        <li id="section-35">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>If we construct a window, it’s <code>Destructible</code> is a child of our main
<code>Destructible</code>, not the child <code>Destructible</code> for the specific socket. A
Window is supposed to outlive a socket and reconnect if the socket breaks but
recovery is possible, so both the socket and window a destructibly children
of our <code>Connectee</code> object manager.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype._getOrCreateWindow = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, promise</span>) </span>{
    <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._getConnection(promise)
    <span class="hljs-keyword">if</span> (connection.window == <span class="hljs-literal">null</span>) {
</pre></div></div>

        </li>


        <li id="section-36">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>As noted above, the <code>Window</code> is a child of the <code>Connectee</code>, not
the <code>Socket</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._destructible.monitor([ <span class="hljs-string">'window'</span>, promise ], <span class="hljs-literal">true</span>, <span class="hljs-keyword">this</span>, <span class="hljs-string">'_window'</span>, promise, <span class="hljs-keyword">async</span>())
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> windowed.window
    }
})

</pre></div></div>

        </li>


        <li id="section-37">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO Really need to set some sort of panic for Turnstile, automatic panic,
where if it gets too full it doesn’t shed, it crashes.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype._socket = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible, message, socket</span>) </span>{
    <span class="hljs-keyword">this</span>._connections.put(message.from, { <span class="hljs-attr">destructible</span>: destructible })
    destructible.destruct.wait(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._connections.remove(message.from)
    })
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._getOrCreateWindow(message.from, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">window</span>) </span>{
        destructible.monitor(<span class="hljs-string">'conduit'</span>, <span class="hljs-keyword">this</span>, <span class="hljs-string">'_conduit'</span>, message.from, <span class="hljs-built_in">window</span>, socket, <span class="hljs-keyword">async</span>())
    })
})

</pre></div></div>

        </li>


        <li id="section-38">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Using a Turnstile for the initialization.</p>
<p>TODO Feel like it is time to consider whether there is some way to amalgamate
Turnstile, Procession and Destructible, or maybe revisit where you’re still
using Turnstile to abend and insist that the user provide a callback to
listen to run it. Also, don’t you want to use a full bouquet of errors to
report from Turnstile when it blows up?</p>

            </div>

        </li>


        <li id="section-39">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Connectee.prototype.socket = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, socket</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-40">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>We add <code>now</code> to our unique socket key because there maybe some overlap
while waiting for the previous socket to shutdown.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._destructible.monitor([ <span class="hljs-string">'socket'</span>, message.from, <span class="hljs-built_in">Date</span>.now() ], <span class="hljs-literal">true</span>, <span class="hljs-keyword">this</span>, <span class="hljs-string">'_socket'</span>, message, socket, <span class="hljs-literal">null</span>)
}

</pre></div></div>

        </li>


        <li id="section-41">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Note that there are three recoverable errors. The first is the request
connection and upgrade negotiation. We have a try/catch for that error below.
Then we can have an error on read or write to the socket. The <code>Socket</code>
utility from Procession logs and error and ends the inbox or outbox
procession.</p>

            </div>

        </li>


        <li id="section-42">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Connector.prototype._connection = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible, demur, to, window</span>) </span>{
    <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        destructible.destroy()
    }], [<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> location = url.parse(<span class="hljs-keyword">this</span>._router.properties[to.promise].location)
        <span class="hljs-keyword">var</span> request = http.request({
            <span class="hljs-attr">host</span>: location.hostname,
            <span class="hljs-attr">port</span>: +location.port,
            <span class="hljs-attr">headers</span>: Downgrader.headers({
                <span class="hljs-string">'x-diffuser-from-promise'</span>: <span class="hljs-keyword">this</span>._router.from.promise,
                <span class="hljs-string">'x-diffuser-from-index'</span>: <span class="hljs-keyword">this</span>._router.from.index,
                <span class="hljs-string">'x-diffuser-to-promise'</span>: to.promise,
                <span class="hljs-string">'x-diffuser-to-index'</span>: to.index
            })
        })
        destructible.destruct.wait(request, <span class="hljs-string">'abort'</span>)
        delta(<span class="hljs-keyword">async</span>()).ee(request).on(<span class="hljs-string">'upgrade'</span>)
        request.end()
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
        <span class="hljs-built_in">console</span>.log(error.stack)
        logger.error(<span class="hljs-string">'request'</span>, { <span class="hljs-attr">stack</span>: error.stack })
        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">async</span>.break, <span class="hljs-literal">false</span>, destructible ]
    }], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, socket, head</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'socketed'</span>)
        <span class="hljs-keyword">var</span> wait = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            demur.reset()
            <span class="hljs-keyword">var</span> readable = <span class="hljs-keyword">new</span> Staccato.Readable(socket)
            <span class="hljs-keyword">var</span> writable = <span class="hljs-keyword">new</span> Staccato.Writable(socket)
            destructible.monitor(<span class="hljs-string">'socket'</span>, <span class="hljs-literal">true</span>, Socket, { <span class="hljs-attr">to</span>: to, <span class="hljs-attr">location</span>: location }, readable, writable, head, <span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">inbox, outbox</span>) </span>{
            destructible.monitor(<span class="hljs-string">'conduit'</span>, Conduit, inbox, outbox, <span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">conduit</span>) </span>{
            <span class="hljs-keyword">var</span> connection = conduit.connect({ <span class="hljs-attr">method</span>: <span class="hljs-string">'window'</span>, <span class="hljs-attr">inbox</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">outbox</span>: <span class="hljs-literal">true</span> })
            <span class="hljs-built_in">window</span>.connect(connection.inbox, connection.outbox)
            <span class="hljs-keyword">return</span> [ <span class="hljs-literal">true</span>, destructible ]
        })
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'returning'</span>, <span class="hljs-built_in">arguments</span>)
    })
})

Connectee.prototype._connect = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible, to, shifter</span>) </span>{
    <span class="hljs-keyword">var</span> demur = <span class="hljs-keyword">new</span> Demur({ <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> })
    destructible.destruct.wait(demur, <span class="hljs-string">'cancel'</span>)
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._getOrCreateWindow(to, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">window</span>) </span>{
        <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._connection.get(to)

</pre></div></div>

        </li>


        <li id="section-43">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Client side destructible is the entire reconnect loop, not an
individual socket.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        connection.destructibles.socket = destructible

        destructible.destruct.wait(<span class="hljs-built_in">window</span>, <span class="hljs-string">'truncate'</span>)
        <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                demur.retry(<span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (destructible.destroyed) {
                    <span class="hljs-keyword">return</span> [ loop.break ]
                }
                destructible.monitor(<span class="hljs-string">'connection'</span>, <span class="hljs-literal">true</span>, <span class="hljs-keyword">this</span>, <span class="hljs-string">'_connection'</span>, to, <span class="hljs-built_in">window</span>, <span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connected, destructible</span>) </span>{
                <span class="hljs-keyword">if</span> (connected) {
                    demur.reset()
                }
                <span class="hljs-built_in">console</span>.log(destructible.completed.open)
                destructible.completed.wait(<span class="hljs-keyword">async</span>())
            })
        })()
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._connections.remove(to)
    })
})

<span class="hljs-built_in">module</span>.exports = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, destructible</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Connectee(destructible)
})

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
